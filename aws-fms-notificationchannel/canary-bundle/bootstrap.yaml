AWSTemplateFormatVersion: '2010-09-09'
Description: This template creates an SNS topic and IAM policy compatible with FMS notification channels.
Resources:
  Topic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: SnsTopic
      TopicName: SnsTopic
      KmsMasterKeyId: !GetAtt SNSKMSEncryptionKey.Arn
  TopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref Topic
      PolicyDocument:
        Id: __default_policy_ID
        Version: '2008-10-17'
        Statement:
          - Sid: AWSFirewallManagerSNSPolicy
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:role/aws-service-role/fms.amazonaws.com/AWSServiceRoleForFMS
            Action:
              - sns:GetTopicAttributes
              - sns:SetTopicAttributes
              - sns:AddPermission
              - sns:RemovePermission
              - sns:DeleteTopic
              - sns:Subscribe
              - sns:ListSubscriptionsByTopic
              - sns:Publish
              - sns:Receive
            Resource: !Ref Topic
  SNSKMSEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: 'true'
      Enabled: 'true'
      KeyPolicy:
        Version: '2012-10-17'
        Id: 'SNSKMSEncryptionKey'
        Statement:
          - Sid: "Allow admin account to use the key"
            Effect: Allow
            Principal:
              AWS: !Ref AWS::AccountId
            Action:
              - kms:*
            Resource: '*'
          - Sid: "Allow AWS SNS to use key"
            Effect: Allow
            Principal:
              Service:
                - "sns.amazonaws.com"
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource: '*'
  LambdaWaiter:
    Type: "AWS::Lambda::Function"
    Properties:
      Handler: "index.handler"
      Runtime: "nodejs16.x"
      Timeout: 900
      Role: !ImportValue LambdaExecutionRole
      Code:
        ZipFile:
          !Sub |
            exports.handler = async function(event, context) {
              var response = require('cfn-response');
              var waitTimeSeconds = event.ResourceProperties.WaitSeconds;
              var waitTime = waitTimeSeconds * 1000;
              var attmeptCount = 3;
              var fakeContext = {
                logStreamName: context.logStreamName,
                done: function() {}
              }
              console.log("Starting initial wait period");
              await new Promise(resolve => setTimeout(resolve, waitTime));
              for (var i = 1; i <= attmeptCount; i++) {
                console.log("Attempt " + i);
                response.send(event, fakeContext, response.SUCCESS, {}, "Waiter-" + waitTimeSeconds + "-Seconds");
                await new Promise(resolve => setTimeout(resolve, 10 * 1000));
              }
              context.done();
            };
Outputs:
  Topic:
    Description: The SNS topic to be used by the notification channel.
    Value: !Ref Topic
    Export:
      Name: SnsTopicArn
  LambdaWaiter:
    Value: !GetAtt LambdaWaiter.Arn
    Export:
      Name: LambdaWaiter
  SNSKMSEncryptionKey:
    Description: The KMS encryption key used to enable SSE on SNS topic.
    Value: !GetAtt SNSKMSEncryptionKey.Arn
    Export:
      Name: SNSKMSEncryptionKey
